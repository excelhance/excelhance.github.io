<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>L‚ÄôArchiviste - jeu solo</title>
<style>
  
/* ===== BASE ===== */
body {
  background:#0f172a;
  color:#e5e7eb;
  padding:16px;
  font-family:system-ui;
  touch-action: manipulation;
}

body.no-scroll {
  overflow: hidden;
  position: fixed;
  width: 100%;
}

h1 { text-align:center; margin-bottom:12px; }

/* Conteneur flex boutons + pile */
#zone-actions-container {
  display: flex;
  align-items: center;  /* boutons et pile align√©s au milieu */
  gap: 16px;
}

/* Flex pour boutons ‚Üí prennent 70% de l‚Äôespace du conteneur */
#zone-actions {
  display: flex;
  flex-direction: column;
  flex: 0 0 70%;   /* largeur fixe 70% */
}

button {
  cursor: pointer; /* boutons cliquables */
  width:100%;
  padding:6px 12px; /* hauteur r√©duite, largeur inchang√©e */
  margin-bottom:8px;
  border:none;
  border-radius:10px;
  background:#38bdf8;
  color:#0f172a;
  font-weight:bold;
  font-size: 14px;
  transition: all 0.2s;
}
button.regles {
  background:#194570;
  color:#ffffff;
  border:1px solid #ffffff;
}

/* Carte pile */
#carte-pile {
  width: 70px;
  height: 100px;
  border-radius: 10px;
  background-image: 
    url("https://i.postimg.cc/YSFq8L3q/Dos-carte-v2.jpg"); /* https://postimages.org/ */
  background-size: cover;
  background-position: center;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: #ffffff;
  font-size: 1.3rem;
}

/* ===== POPUP 10 + AS ===== */
#popup-10as {
  background:#020617;
  border:2px solid #38bdf8;
  border-radius:12px;
  padding:10px;
  margin-bottom:12px;
}

.popup-10as .cartes{
  display: flex;
  justify-content: center;
  gap: 6px;
  margin-bottom: 8px;
}
#popup-10as .carte {
  pointer-events: none;
  cursor: default;
}

#popup-10as button {
  width:48%;
  cursor: pointer; /* boutons cliquables */
}

/* Bouton Joker inactif/actif/utilis√© */
button.joker-inactif { color:#FF0000; }
button.joker-actif { background:#fff; color:#FF0000; }
button.joker-utilise { cursor: pointer; background:#dc2626; color:#fff; }

/* ===== ZONE CENTRALE ‚Äì COULEURS DYNAMIQUES ===== */
.zone {
  border:2px dashed #475569;
  border-radius:12px;
  padding:10px;
  margin-bottom:14px;
}
/* R√®gle de base commune √† TOUTES les zones */
.zone-title {
  text-align:center;
  margin-bottom:6px;
  color:#94a3b8;
}

/* Couleurs dynamiques */
.zone.vert {
  border-color:#22c55e;
}
.zone.vert .zone-title {
  color:#22c55e;
}

.zone.orange {
  border-color:#f97316;
}
.zone.orange .zone-title {
  color:#f97316;
}

.zone.rouge {
  border-color:#dc2626;
}
.zone.rouge .zone-title {
  color:#dc2626;
}
  
.cartes {
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:center;
  min-height:110px;
}

/* ===== CARTES ===== */
.carte {
  width:70px;
  height:100px;
  background:#fff;
  border-radius:10px;
  color:#000;
  position:relative;
  box-shadow:0 4px 8px rgba(0,0,0,.4);
  cursor:pointer;
  transition: margin-top 0.2s ease, outline 0.2s ease;
}
  
.carte.selectionnee {
  outline:3px solid #38bdf8;
  margin-top: -6px;
}
  
.carte.rouge { color:#b91c1c }

.valeur { position:absolute; top:6px; left:6px; font-weight:bold; }
.centre { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:2rem; }

/* ===== ARCHIVES ===== */
.archives {
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
}

.archive {
  border:2px solid #475569;
  border-radius:10px;
  padding:6px;
  position:relative;
}

.archive h3 { text-align:center; margin-bottom:4px; }

.archive-cartes {
  display:flex;
  flex-direction:column;
  gap:4px;
}

/* Compteur de cartes dans l'archive */
.archive .compteur {
    text-align: center;
    font-weight: bold;
    color: #06b6d4; /* bleu cyan */
    font-size: 0.9rem;
    margin-bottom: 4px; /* espace entre compteur et ic√¥ne de l'archive */
}

/* Cartes r√©duites dans les archives */
.archive-cartes .carte {
  width:42px;
  height:60px;
  font-size:0.8rem;
}

/* Animation re-pioche */
@keyframes slideIn {
  0% { transform: translateY(-30px); opacity:0; }
  100% { transform: translateY(0); opacity:1; }
}
.carte.repioche { animation: slideIn 0.4s ease forwards; }

/* Joker marqueur */
.joker-marqueur {
  position:absolute;
  top:2px;
  right:2px;
  font-size:1rem;
}

/* pour bloquer les 3 boutons de jeu en pr√©sence de la popup As+10 */
.ui-bloquee button {
  pointer-events: none;
  opacity: 0.6;
}
/* Bouton d√©sactiv√© individuellement */
.bouton-bloque {
  pointer-events: none;
  opacity: 0.6;
}
/* pour bloquer les 3 boutons de jeu une fois la pop-up Victoire affich√©e */
.victoire-ui-bloquee *:not(#rejouer) {
  pointer-events: none;
  opacity: 1;
}
#rejouer {
  pointer-events: auto ;
  opacity: 1 ;
  background: #22c55e; /* victoire */
  color: #ffffff;
}

#rejouer.defaite {
  background: #dc2626; /* rouge */
  color: #ffffff;
}

/* Ligne "Credits" */
#footer-credit {
  margin-top: 16px;
  text-align: center;
  font-size: 0.75rem;
  color: #94a3b8;
}
#footer-credit a {
  color: inherit;
  text-decoration: none;
}
#footer-credit a:hover {
  text-decoration: underline;
}

/* Page des R√àGLES */
#page-regles {
  position: fixed;
  inset: 0;
  max-width: 100%;
  box-sizing: border-box;
  background: #020617;
  color: #e5e7eb;
  padding: 20px;
  overflow-y: auto;
  z-index: 100;
  -webkit-overflow-scrolling: touch; /* inertie iOS */
  padding-bottom: 120px; /* espace suffisant sous le bouton */
}

#page-regles h2 {
  text-align: center;
  margin-bottom: 16px;
}

.regles-contenu {
  max-width: 600px;
  margin: auto;
  font-size: 0.9rem;
  line-height: 1.4;
}

#btn-retour-jeu {
  margin: 30px auto 0;
  display: block;
  width: 70%;
}

/* Canvas utilis√© par canvas-confetti */
canvas {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 10000;
}

</style>
</head>
<body>

<h1>üÇ°&nbsp;&nbsp;L‚ÄôArchiviste&nbsp;&nbsp;üÇ°</h1>

<div id="zone-actions-container">
  <div id="zone-actions">
    <button id="btn-regles" class="regles">R√àGLES</button>
    <button id="piocher">PIOCHER</button>
    <button id="defausser">D√©fausser</button>
    <button id="joker">Activer Joker</button>
  </div>

  <!-- Colonne pile √† droite des boutons -->
  <div id="carte-pile" title="Pioche">52</div>
</div>

<button id="rejouer" style="display:none">
  REJOUER UNE PARTIE
</button>
  
<div id="popup-10as" style="display:none;"></div>

<div id="user-confirmation" style="display:none">
  <p id="confirmation-message"></p>
  <button id="btn-oui">Oui</button>
  <button id="btn-non">Non</button>
</div>

<div class="zone zone-centre-neutre" id="zone-centrale">
  <div class="zone-title">Zone Centrale</div>
  <div class="cartes" id="centre"></div>
</div>

<div class="zone">
  <div class="zone-title">Archives</div>
  <div class="archives">
    <div class="archive" data-c="‚ô†"><h3>‚ô†</h3><div class="archive-cartes"></div></div>
    <div class="archive" data-c="‚ô•"><h3 style="color:#b91c1c">‚ô•</h3><div class="archive-cartes"></div></div>
    <div class="archive" data-c="‚ô¶"><h3 style="color:#b91c1c">‚ô¶</h3><div class="archive-cartes"></div></div>
    <div class="archive" data-c="‚ô£"><h3>‚ô£</h3><div class="archive-cartes"></div></div>
  </div>
</div>
  
<div id="footer-credit">
  <a href="https://www.linkedin.com/in/nathan-fauconnier-developpeur-excel-vba-freelance" target="_blank" rel="noopener">
    Powered by N.Fauconnier √ó ChatGPT
  </a>
</div>

<div id="page-regles" style="display:none">
  <h2>R√®gles du jeu ‚Äî L‚ÄôArchiviste</h2>

  <div class="regles-contenu">
    <p><strong>üéØ But du jeu :</strong> placer 10 cartes dans une Archive</p>

    <h3>Tour de jeu</h3>
    <ul>
      <li>Piocher 2 cartes (ou 3 en cas de repioche)</li>
      <li>Effectuer une action : archiver OU d√©fausser OU Joker</li>
      <li>Piocher => action => piocher ...</li>
    </ul>

    <h3>Zone Centrale</h3>
    <p>Ne peut contenir que 7 cartes au maximum !</p>

    <h3>D√©fausses possibles</h3>
    <ul>
      <li><strong>2 cartes de m√™me valeur</strong></li>
      <li><strong>2 + 5</strong> (+ 1 carte optionnelle ‚úÖ)</li>
      <li><strong>6 + 9</strong> (+ rejouer SANS piocher ‚úÖ)</li>
      <li><strong>10 + Dame</strong> (+ supprimer un Joker actif ‚≠êÔ∏è)</li>
      <li><strong>10 + Roi</strong> => d√©fausse TOUTES les cartes üî•</li>
      <li><strong>10 + As</strong> (+ voir les 3 prochaines cartes ‚úÖ)</li>
    </ul
    <p>‚ö†Ô∏è Les cartes d√©fauss√©es n'apparaitront plus !</p>

    <h3>Activation du Joker</h3>
    <ul>
      <li>Efface une Archive qui a au moins 1 carte</li>
      <li>Les cartes sont rem√©lang√©es dans la pioche</li>
    </ul>
    <p>‚ö†Ô∏è Ne peut √™tre utilis√© qu‚Äôune seule fois !</p>

    <h3>D√©faite</h3>
    <ul>
      <li>Activation d'un 2√®me Joker s'il est d√©j√† actif</li>
      <li>Aucune Archive compl√©t√©e + aucune action possible</li>
    </ul>
  </div>

  <button id="btn-retour-jeu">Retour au jeu</button>
</div>

<!-- Librairie confettis de victoire -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

<script>
/* =====================================================
   √âTAT GLOBAL
===================================================== */
const centre = document.getElementById("centre");
const btnPioche = document.getElementById("piocher");
const btnJoker = document.getElementById("joker");
let pioche = [];
let etat = "pioche";
let jokerUtilise = false;
let jokerEnAttente = false;
let premierePioche = true;
let attenteAction = false;
let vision10AsActive = false;
let cartesVision10As = [];
let sessionStart = null;
let sessionTerminee = false;

const archives = { "‚ô†":[], "‚ô•":[], "‚ô¶":[], "‚ô£":[] };
const couleurs = ["‚ô†","‚ô•","‚ô¶","‚ô£"];
const valeurs = [["A",1],["2",2],["3",3],["4",4],["5",5],["6",6],["7",7],["8",8],["9",9],["10",10],["V",11],["D",12],["R",13]];

btnJoker.classList.add("joker-inactif")
debloquerBoutons(["piocher"]);
bloquerBoutons(["joker","defausser"]);

/* =====================================================
   BLOCAGE DYNAMIQUE DES BOUTONS
===================================================== */
function bloquerBoutons(ids){
  if(!Array.isArray(ids)) ids = [ids];
  ids.forEach(id => {
    const btn = document.getElementById(id);
    if(btn) btn.classList.add("bouton-bloque");
  });
}
function debloquerBoutons(ids){
  if(!Array.isArray(ids)) ids = [ids];
  ids.forEach(id => {
    const btn = document.getElementById(id);
    if(btn) btn.classList.remove("bouton-bloque");
  });
}
function gererEtatBoutons() {
  const selection = document.querySelectorAll("#centre .carte.selectionnee").length;
  const valeursSelectionnees = [...document.querySelectorAll(".carte.selectionnee")].map(c => +c.dataset.valeur);

  // ===== Gestion du bouton Joker =====
  const auMoinsUneArchiveNonVide = couleurs.some(c => archives[c].length > 0);
  if (!auMoinsUneArchiveNonVide) {
    bloquerBoutons("joker");
  } else {
    debloquerBoutons("joker");
  }

  // ===== Gestion des autres boutons selon s√©lection =====
  if (selection === 0) {
    bloquerBoutons("defausser");
    debloquerBoutons(["piocher"]); // aucun bloque ici, sauf D√©fausser / Joker d√©j√† g√©r√©s
  } else if (selection === 1) {
    bloquerBoutons("piocher"); // le bouton Pioche est bloqu√©
  } else if (selection === 2) {
    bloquerBoutons("piocher"); // Pioche bloqu√©e
  } else if (selection === 3 &&
             valeursSelectionnees.includes(2) &&
             valeursSelectionnees.includes(5)) {
    bloquerBoutons("piocher");
  }
}

/* =====================================================
   PAGE DES REGLES
===================================================== */
document.getElementById("btn-regles").onclick = () => {
  document.body.classList.add("no-scroll");
  document.getElementById("page-regles").style.display = "block";
  document.getElementById("zone-actions").classList.add("ui-bloquee");
};

document.getElementById("btn-retour-jeu").onclick = () => {
  document.body.classList.remove("no-scroll");
  document.getElementById("page-regles").style.display = "none";
  document.getElementById("zone-actions").classList.remove("ui-bloquee");
};

/* =====================================================
   INITIALISATION PAQUET
===================================================== */
function creerPaquet(){
  pioche=[];
  couleurs.forEach(c=>{
    valeurs.forEach(v=>{
      pioche.push({ label:v[0], valeur:v[1], couleur:c });
    });
  });
  pioche.sort(()=>Math.random()-.5);
}

function updateCouleurZoneCentrale(){
  const zone = centre.closest(".zone");
  const nb = centre.children.length;

  zone.classList.remove("vert","orange","rouge");

  if(nb >= 1 && nb <= 4){
    zone.classList.add("vert");
  } else if(nb === 5){
    zone.classList.add("orange");
  } else if(nb >= 6){
    zone.classList.add("rouge");
  }
}

/* =====================================================
   CREATION CARTE HTML
===================================================== */
function creerCarteHTML(carte, interactive=true){
  const d=document.createElement("div");
  d.className="carte"+((carte.couleur==="‚ô•"||carte.couleur==="‚ô¶")?" rouge":"");
  d.dataset.valeur = carte.valeur;
  d.dataset.label = carte.label;
  d.dataset.couleur = carte.couleur;
  d.innerHTML = `<div class="valeur">${carte.label}</div><div class="centre">${carte.couleur}</div>`;
  /*if(interactive) d.onclick = ()=>d.classList.toggle("selectionnee");*/
  if(interactive){
  d.onclick = () => {
    d.classList.toggle("selectionnee");
    gererEtatBoutons();
  };
}
  return d;
}

/* =====================================================
   PIOCHE + RE-POCHE
===================================================== */
btnPioche.onclick = () => {

  const sel = [...document.querySelectorAll(".carte.selectionnee")];

  if (centre.children.length + 2 > 7) {
    alert("‚õîÔ∏è Zone Centrale satur√©e, pioche impossible");
    return;
  }

  // ===== Re-pioche volontaire avec confirmation =====
  if (!premierePioche && attenteAction && sel.length === 0 && !jokerEnAttente) {

    document.getElementById("zone-actions").classList.add("ui-bloquee");

    confirmJeu(
      "Confirmer repioche ? (‚ö†Ô∏è 3 cartes seront pioch√©es au lieu de 2)",
      reponse => {

        document.getElementById("zone-actions").classList.remove("ui-bloquee");

        if (!reponse) {
          return;
        }

        piocherCartes(3);
      }
    );

    return; // ‚õî on sort IMP√âRATIVEMENT
  }

  // ===== Pioche standard =====
  const nb = premierePioche ? 2 : 2;
  premierePioche = false;
  piocherCartes(nb);
};

// ----------------------------------------------------
function piocherCartes(nb){
  if (centre.children.length + nb > 7) {
    alert("‚ö†Ô∏è Zone Centrale satur√©e, pioche impossible !");
    return;
  }

  for (let i = 0; i < nb; i++) {
    if (pioche.length && centre.children.length < 7) {
      const c = creerCarteHTML(pioche.pop());
      c.classList.add("repioche");
      centre.appendChild(c);
    }
  }

  etat = "action";
  attenteAction = true;
  updateCouleurZoneCentrale();
  updateCompteurPile();
  gererEtatBoutons();
  //bloquerBoutons(["piocher"]);
  //debloquerBoutons(["defausser"]);
  checkJeu();
}

function updateCompteurPile(){
  const cartePile = document.getElementById("carte-pile");
  if(cartePile) cartePile.textContent = pioche.length;
}
// ----------------------------------------------------

/* =====================================================
   POP-UP DE CONFIRMATION DE CERTAINES ACTIONS
===================================================== */
function confirmJeu(message, callback){
  const modal = document.getElementById("user-confirmation");
  document.getElementById("confirmation-message").textContent = message;
  modal.style.display = "block";

  document.getElementById("btn-oui").onclick = () => {
    modal.style.display = "none";
    callback(true);
  };

  document.getElementById("btn-non").onclick = () => {
    modal.style.display = "none";
    callback(false);
  };
}

/* =====================================================
   ARCHIVES
===================================================== */
document.querySelectorAll(".archive").forEach(archive => {
  archive.onclick = () => {

    // Gestion du Chaos (Joker en attente)
    if(jokerEnAttente){
      const arch = archives[archive.dataset.c];
      if(arch.length === 0) return;

      // Vider l'archive choisie et remettre ses cartes dans la pioche de mani√®re m√©lang√©e
      const pileActuelle = pioche.slice();      // copie de la pile actuelle
      const cartesArchive = [...arch];          // copie des cartes de l'archive
      archives[archive.dataset.c] = [];        // vider l'archive
      renderArchive(archive.dataset.c);
      //updateCompteurPile();
      
      // M√©langer les cartes de l'archive
      cartesArchive.sort(() => Math.random() - 0.5);
      
      if (pileActuelle.length >= 4) {
          // Conserver les 3 premi√®res cartes en haut, m√©langer les cartes de l'archive en dessous
          const top3 = pileActuelle.slice(0, 3);
          const reste = pileActuelle.slice(3);
          pioche = [...top3, ...cartesArchive, ...reste];
      } else {
          // M√©langer les cartes de l'archive et les mettre en dessous de la pile existante
          pioche = [...pileActuelle, ...cartesArchive];
      }

      // Vider la Zone Centrale
      while(centre.firstChild){
        centre.removeChild(centre.firstChild);
      }
      updateCompteurPile();
      updateCouleurZoneCentrale();
      gererEtatBoutons();

      // Marqueur visuel Joker (au-dessus du titre, sans d√©caler l'ic√¥ne)
      const marqueur = document.createElement("div");
      marqueur.className = "joker-marqueur";
      marqueur.textContent = "üÉè";
      marqueur.style.position = "absolute";
      marqueur.style.top = "4px";
      marqueur.style.right = "4px";
      archive.querySelector("h3").appendChild(marqueur);

      // Changer visuel du bouton Joker
      const btnJoker = document.getElementById("joker");
      btnJoker.style.backgroundColor = "#dc2626"; // rouge l√©ger
      btnJoker.style.color = "#fff";;

      jokerEnAttente = false;
      btnJoker.classList.remove("joker-actif");
      btnJoker.classList.add("joker-utilise");
      checkJeu(); // check d'une victoire ou d'une d√©faite
      attenteAction = false;
      return;
    }

    // Classement d'une carte dans l'archive
    if(etat !== "action") return;
    const sel = [...document.querySelectorAll(".carte.selectionnee")];
    if(sel.length !== 1) return;
    const d = sel[0];
    if(d.dataset.couleur !== archive.dataset.c) return;

    archives[archive.dataset.c].push({
      valeur: +d.dataset.valeur,
      label: d.dataset.label,
      couleur: d.dataset.couleur
    });
    d.remove();
    renderArchive(archive.dataset.c);

    etat = "pioche";
    updateCouleurZoneCentrale();
    gererEtatBoutons();
    checkJeu(); // check d'une victoire ou d'une d√©faite
    attenteAction = false;
  };
});

/* =====================================================
   RENDU ARCHIVES
===================================================== */
function renderArchive(c){
  const archiveDiv = document.querySelector(`.archive[data-c="${c}"]`);
  const cont = archiveDiv.querySelector(".archive-cartes");
  cont.innerHTML = "";

  // Tri et ajout des cartes
  archives[c]
      .sort((a,b) => a.valeur - b.valeur)
      .forEach(carte => { cont.appendChild(creerCarteHTML(carte,false)) });

  // ===== Compteur =====
  let compteurEl = archiveDiv.querySelector(".compteur");
  if(!compteurEl){
      compteurEl = document.createElement("div");
      compteurEl.className = "compteur";
      archiveDiv.insertBefore(compteurEl, archiveDiv.querySelector(".archive-cartes"));
  }
  compteurEl.textContent = archives[c].length;
}

/* =====================================================
   D√âFAUSSE (R√àGLES COMPL√àTES UNIFI√âES)
===================================================== */
document.getElementById("defausser").onclick = () => {
    if(etat !== "action") return;

    const sel = [...document.querySelectorAll(".carte.selectionnee")];
    if(sel.length < 2) return;

    const v = sel.map(c => +c.dataset.valeur).sort((a,b) => a-b);

    // ===== M√™me valeur =====
    if (v[0] === v[1] && sel.length === 2) {
      sel.forEach(c => c.remove());
      etat = "pioche";
      attenteAction = false;  // pas de re-pioche automatique
      updateCouleurZoneCentrale();
      gererEtatBoutons();
      checkJeu(); // check d'une victoire ou d'une d√©faite
      return;
    }

    // ===== 2 + 5 + 1 carte suppl√©mentaire (optionnelle) =====
    if(v.includes(2) && v.includes(5) && [2,3].includes(sel.length)){
            sel.forEach(c => c.remove());

            etat = "pioche";       // attente action utilisateur
            attenteAction = false;   // emp√™che re-pioche imm√©diate
            updateCouleurZoneCentrale();
            gererEtatBoutons();
            checkJeu(); // check d'une victoire ou d'une d√©faite
            return;
    }
    if (sel.length > 2) {
       alert("‚ö†Ô∏è Trop de cartes s√©lectionn√©es (max 2 identiques)");
       return;
    }

    // ===== 6 + 9 => d√©fausser les 2 cartes et rejouer SANS repiocher =====
    if(v[0] === 6 && v[1] === 9 && sel.length === 2){
        sel.forEach(c => c.remove());  // D√©fausse des cartes

        attenteAction = false;   // emp√™che re-pioche imm√©diate
        updateCouleurZoneCentrale();
        gererEtatBoutons();
        checkJeu(); // check d'une victoire ou d'une d√©faite
        return;  // rejouer imm√©diatement, aucune pioche
    }

    // ===== 10 + Dame => retirer un Joker actif =====
    if(v[0] === 10 && v[1] === 12 && sel.length === 2){
        if(jokerUtilise){
            // R√©initialisation Joker
            jokerUtilise = false;
            jokerEnAttente = false;
    
            // Bouton Joker -> √©tat normal
            btnJoker.classList.remove("joker-utilise","joker-actif");
            btnJoker.style.backgroundColor = "";
            btnJoker.style.color = "";
    
            // Suppression de l‚Äôic√¥ne Joker sur l‚Äôarchive
            document.querySelectorAll(".joker-marqueur").forEach(j => j.remove());
        }
    
        // D√©fausse des cartes
        sel.forEach(c => c.remove());
    
        etat = "pioche";
        attenteAction = false; // pioche standard ensuite
        updateCouleurZoneCentrale();
        gererEtatBoutons();
        checkJeu(); // check d'une victoire ou d'une d√©faite
        return;
    }

    // ===== 10 + Roi =====
    if(v[0] === 10 && v[1] === 13 && sel.length === 2){
        // Vider la Zone Centrale et retirer les cartes s√©lectionn√©es
        centre.innerHTML = "";
        sel.forEach(c => c.remove());

        etat = "pioche";       // attente de l'action utilisateur
        attenteAction = false;   // emp√™che re-pioche imm√©diate
        updateCouleurZoneCentrale();
        gererEtatBoutons();
        checkJeu(); // check d'une victoire ou d'une d√©faite
        return;
    }

    // ===== 10 + As =====
    if (v[0] === 1 && v[1] === 10 && sel.length === 2){
    
        // D√©fausse des cartes s√©lectionn√©es
        sel.forEach(c => c.remove());
    
        // Pr√©lever jusqu‚Äô√† 3 cartes (s√©curit√©)
        cartesVision10As = pioche.slice(-3).reverse();
    
        // Construction popup
        const popup = document.getElementById("popup-10as");
        popup.innerHTML = `
          <div class="cartes" style="display:flex;gap:6px;justify-content:center;margin-bottom:8px"></div>
          <div style="display:flex;gap:8px;justify-content:center">
            <button id="btn-conserver">Conserver pour la pioche suivante</button>
            <button id="btn-remelanger">M√©langer sous la pile</button>
          </div>
        `;
    
        const zoneCartes = popup.querySelector(".cartes");
        cartesVision10As.forEach(c => {
            zoneCartes.appendChild(creerCarteHTML(c, false));
        });
    
        // Affichage forc√©
        popup.style.display = "block";
        popup.style.position = "relative";
        popup.style.zIndex = "50";
        vision10AsActive = true;

        // Blocage UI principale
        document.getElementById("zone-actions").classList.add("ui-bloquee");

        // √âtat bloquant
        etat = "action";        // ‚¨ÖÔ∏è IMPORTANT
        attenteAction = true;
    
        return;
    }
};
document.addEventListener("click", e => {
  if (!vision10AsActive) return;

  // === Conserver ===
  if (e.target.id === "btn-conserver") {
      // Les cartes restent au sommet
      fermerPopup10As();
  }

  // === Retour dans la pile ===
  if (e.target.id === "btn-remelanger") {

      // Retirer les cartes du sommet
      pioche.splice(-cartesVision10As.length, cartesVision10As.length);

      // R√©insertion al√©atoire
      pioche.push(...cartesVision10As);
      pioche.sort(() => Math.random() - 0.5);

      fermerPopup10As();
  }
});

function fermerPopup10As(){
  document.getElementById("popup-10as").style.display = "none";
  cartesVision10As = [];
  vision10AsActive = false;

  // D√©bloquer les boutons de jeu
  document.getElementById("zone-actions").classList.remove("ui-bloquee");

  // Reprise normale du jeu
  etat = "pioche";
  attenteAction = false;
  updateCouleurZoneCentrale();
  gererEtatBoutons();
  checkJeu(); // check d'une victoire ou d'une d√©faite
}

/* =====================================================
   JOKER / CHAOS
===================================================== */
btnJoker.onclick = () => {

  // üîÅ Toggle OFF si le Joker est simplement en attente
  if (jokerEnAttente) {
    jokerUtilise= false;
    jokerEnAttente = false;
    btnJoker.classList.remove("joker-actif");
    updateCouleurZoneCentrale();
    checkJeu(); // check d'une victoire ou d'une d√©faite
    return;
  }
  
  // ‚ùå Joker d√©j√† consomm√© ‚Üí confirmer avant d√©faite
  if (jokerUtilise && !jokerEnAttente) {
  document.getElementById("zone-actions").classList.add("ui-bloquee");
  confirmJeu("‚ö†Ô∏è Le Joker a d√©j√† √©t√© utilis√©. Confirmez-vous l'activation de cette action ?",
      reponse => {
          document.getElementById("zone-actions").classList.remove("ui-bloquee");
          if (reponse) {
              sessionTerminee = true; // pour √©viter double log
              envoyerLog("DEFAITE", { duree: dureeSession() });
              finDePartie("‚ùå D√©faite ‚Äî Chaos incontr√¥l√©", "DEFAITE");
          }
          // si reponse = false, on ne fait rien, l'utilisateur reste dans le jeu
      }
  );
  return; // on sort imm√©diatement pour ne pas continuer l'ex√©cution
}

  // ‚ùå Aucun archive non vide
  const nonVides = couleurs.filter(c=>archives[c].length);
  if(nonVides.length===0) return;

  // ‚úÖ Activation du Joker
  jokerUtilise=true;
  jokerEnAttente=true;
  btnJoker.classList.add("joker-actif");
};

/* =====================================================
   FIN D'UNE PARTIE
===================================================== */
function finDePartie(message, type = "VICTOIRE") {
  alert(message);

  // Blocage total du jeu
  document.body.classList.add("victoire-ui-bloquee");

  // Masquer les boutons de jeu
  const zoneActions = document.getElementById("zone-actions-container");
  if (zoneActions) {
    zoneActions.style.display = "none";
  }

  // Bouton Rejouer contextualis√©
  const btnReplay = document.getElementById("rejouer");
  if (btnReplay) {
    btnReplay.classList.remove("defaite");
    btnReplay.style.display = "block";

    if (type === "DEFAITE") {
      btnReplay.classList.add("defaite");
      btnReplay.textContent = "‚ò†Ô∏è D√âFAITE : REJOUER";
    } else {
      btnReplay.textContent = "üèÜ VICTOIRE : REJOUER";
    }

    btnReplay.onclick = () => location.reload();
  }
}

/* =====================================================*/
function checkJeu(){
    verifierDefaite();
    verifierVictoire();
}
/* =====================================================
   CONDITIONS DE DEFAITE
===================================================== */
function auMoinsUneActionPossible(defaussePossible) {

  const piochePossible =
    pioche.length > 0 &&
    centre.children.length < 6;

  const archivePossible =
    couleurs.some(c => archives[c].length === 10);

  const jokerPossible =
    !jokerUtilise && !jokerEnAttente;

  return (
    piochePossible ||
    defaussePossible ||
    archivePossible ||
    jokerPossible
  );
}

function verifierDefaite() {

  // ‚úÖ V√©rification √©tat actuel
  const piocheVide = pioche.length === 0;
  const aucuneArchiveComplete = !couleurs.some(c => archives[c].length === 10);

  // üîπ D√©fausse th√©orique possible dans la zone centrale
  const defaussePossible = (() => {
    const cartes = [...centre.children];
    const valeurs = cartes.map(c => +c.dataset.valeur).sort((a,b)=>a-b);

    // Paires de m√™me valeur
    if(valeurs.some(v => valeurs.filter(x => x === v).length === 2)) return true;

    // Combinaisons sp√©ciales
    if(valeurs.includes(2) && valeurs.includes(5)) return true;
    if(valeurs.includes(6) && valeurs.includes(9)) return true;
    if(valeurs.includes(10) && valeurs.includes(12)) return true;
    if(valeurs.includes(10) && valeurs.includes(13)) return true;
    if(valeurs.includes(1) && valeurs.includes(10)) return true;

    return false;
  })();

  // üîπ Action r√©ellement possible pour le joueur √† ce moment
  const actionReellePossible = (() => {
    const piochePossible = pioche.length > 0 && centre.children.length < 6;
    const defausseReelle = (etat === "action" && defaussePossible);
    const archivePossible = couleurs.some(c => archives[c].length === 10);
    const jokerPossible = !jokerUtilise && !jokerEnAttente;

    return piochePossible || defausseReelle || archivePossible || jokerPossible;
  })();

  // üîí CAS HISTORIQUE ‚Äî pioche vide + plus aucune action
  if (
    piocheVide &&
    !defaussePossible &&
    aucuneArchiveComplete &&
    etat === "pioche" &&
    !sessionTerminee
  ) {
    sessionTerminee = true;
    envoyerLog("DEFAITE", { duree: dureeSession() });
    finDePartie("‚ùå D√©faite ‚Äî Pioche vide et plus aucune action possible", "DEFAITE");
    return;
  }

  // üÜï CAS ‚Äî seule action attendue impossible (ex: pioche bloqu√©e ou Joker d√©j√† utilis√©)
  if (
    etat === "pioche" &&
    !actionReellePossible &&
    !sessionTerminee
  ) {
    sessionTerminee = true;
    envoyerLog("DEFAITE", { duree: dureeSession() });
    finDePartie("‚ùå D√©faite ‚Äî Plus aucune action possible", "DEFAITE");
  }
}

/* =====================================================
   CONDITION DE VICTOIRE
===================================================== */
function verifierVictoire(){
  couleurs.forEach(c=>{
      if(archives[c].length===10 && !sessionTerminee){
          sessionTerminee = true;
          envoyerLog("VICTOIRE", { duree: dureeSession() });
          finDePartie("üèÜ VICTOIRE => Archive compl√©t√©e !", "VICTOIRE");

          // D√©clenchement des confettis apr√®s rendu r√©el de la pop-up
          requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                  lancerConfettisVictoire();
              });
          });
      }
  });
}

// AFFICHAGE DES CONFETTIS LORS D'UNE VICTOIRE
function lancerConfettisVictoire() {
  confetti({
    particleCount: 120,
    spread: 90,
    origin: { y: 0.6 }
  });

  setTimeout(() => {
    confetti({
      particleCount: 80,
      spread: 120,
      origin: { y: 0.4 }
    });
  }, 300);
}

/* =====================================================
   LANCEMENT
===================================================== */
creerPaquet();
updateCompteurPile();
updateCouleurZoneCentrale();
gererEtatBoutons();

/* =====================================================
   GESTION R√âCUP√âRATION DES LOGS
===================================================== */
function envoyerLog(action, options = {}) {
  const payload = JSON.stringify({
    playerId: getPlayerId(),
    action: action,
    date: new Date().toISOString(),
    duree: options.duree ?? null,
    userAgent: navigator.userAgent
  });
  if (action === "VICTOIRE" || action === "DEFAITE") {
    navigator.sendBeacon(
      "https://script.google.com/macros/s/AKfycbwgxdT_l_ent4p_44yn3cMrmn4IFCgX935ivshKrmh7xnDMPoEURDoUEzLFDzWLHMobGw/exec",
      payload
    );
  } else {
    fetch(
      "https://script.google.com/macros/s/AKfycbwgxdT_l_ent4p_44yn3cMrmn4IFCgX935ivshKrmh7xnDMPoEURDoUEzLFDzWLHMobGw/exec",
      { method: "POST", body: payload }
    ).catch(() => {});
  }
}
// G√©n√©rer un identifiant joueur anonyme, sans cookie
function getPlayerId(){
  let id = localStorage.getItem("playerId");
  if(!id){
    id = crypto.randomUUID();
    localStorage.setItem("playerId", id);
  }
  return id;
}
// Chronom√©trer la session de jeu
function dureeSession() {
  return sessionStart
    ? Math.round((Date.now() - sessionStart) / 1000)
    : null;
}

window.addEventListener("load", () => {
  sessionStart = Date.now();
  sessionTerminee = false;
  envoyerLog("SESSION_START");
});

      
</script>
</body>
</html>
